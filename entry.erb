<%# -*- coding: utf-8 -*-%>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
  <link rel="stylesheet" type="text/css" href="default.css">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

  <title>蔵書管理</title>
</head>
<body>
<h1>蔵書管理</h1>
<h2>蔵書データの登録</h2>
<p>登録データを入力してください｜
<a href="list.erb">蔵書データの表示</a>｜
<a href="index.html">メニュー画面に戻る</a></p>
<hr>
<script>
$(document).on('click', ".book_thumbnail", function(){
  /* イベント発火時の処理 */
  const id = this.id;
  console.log(id);
});

$(function() {
  $("#search_button").click(function() {
    const img_list = document.getElementById('book_list');
    while (img_list.firstChild) {
      img_list.removeChild(img_list.firstChild);
    }
    const isbn = $("#search_keyword").val();
    const max_results = 40;
    var index = ""
    const count = 1;
    for (var i = 0; i < count; i++) {
      index = i * max_results;
      const url = "https://www.googleapis.com/books/v1/volumes?q=" + isbn + "&maxResults=" + max_results + "&startIndex=" + index;
      console.log(isbn);
      $.getJSON(url, function(data) {
        console.log(data.items.length);
        for(var i = 0; i < data.items.length; i++){
          if(data.items[i].volumeInfo !== undefined && data.items[i].volumeInfo.imageLinks !== undefined && data.items[i].volumeInfo.imageLinks.smallThumbnail !== undefined){
            const img = document.createElement('img');
            img.src = data.items[i].volumeInfo.imageLinks.smallThumbnail;
            img.id = data.items[i].id;
            img.height = "200"
            img.width = "200"
            img.className = "book_thumbnail";
            $("#book_list").append(img);
            console.log("a");
          }else{
            const img = document.createElement('img');
            img.src = "./image/no-image-icon.png";
            img.height = "200";
            img.width = "200";
            img.className = "book_thumbnail";
            $("#book_list").append(img);
            console.log("b");
          }
        }
        console.log(data);
        if(!data.totalItems) {
          $("#isbn").val("");
          $("#BookTitle").text("");
          $("#BookAuthor").text("");
          $("#isbn10").text("");
          $("#isbn13").text("");
          $("#PublishedDate").text("");
          $("#book_list").text("");
          $("#BookDescription").text("");
          $("#BookMemo").val("");

          $("#message").html('<p class="bg-warning" id="warning">該当する書籍がありません。</p>');
          $('#message > p').fadeOut(3000);

        } else {

    // 該当書籍が存在した場合、JSONから値を取得して入力項目のデータを取得する

          // $("#BookTitle").text(data.items[0].volumeInfo.title);
          // $("#isbn13").text(data.items[0].volumeInfo.industryIdentifiers[0].identifier);
          // $("#isbn10").text(data.items[0].volumeInfo.industryIdentifiers[1].identifier);
          // $("#BookAuthor").text(data.items[0].volumeInfo.authors[0]);
          // $("#PublishedDate").text(data.items[0].volumeInfo.publishedDate);
          // $("#BookDescription").text(data.items[0].volumeInfo.description);
          // $("#book_list").html('<img src=\"' + data.items[0].volumeInfo.imageLinks.smallThumbnail + '\" />');

        }
      });
    }
  });
});
</script>

<button id="hand_entry_button" value="hand_entry" onclick="form_change(this)">手入力</button>
<button id="search_entry_button" value="search_entry" onclick="form_change(this)">本検索</button>

<div id="hand_entry">
  <%# 登録対象データを入力するフォームを表示する アクションはentry %>
  <form method="post" action="entry">
    <table>
      <tr>
        <th>項目名</th><th>入力データ</th>
      </tr>
    <% ['id','title','author','page','publish_date'].each do |name| %>
      <tr>
        <td><%= name %></td>
        <td><input type="text" name="<%=name%>" size="60" /></td>
      </tr>
    <% end %>
    </table>
  <input type="submit" value="登録を実行" />
  </form>
</div>
<hr>
<div id="search_entry">
  <table>
    <tr>
      <th></th><th>入力データ</th>
    </tr>
    <tr>
      <td>検索キーワード</td>
      <td><input id="search_keyword" type="text" value="">
    </td>
    </tr>
  </table>
  <button id="search_button">検索</button>
    <%# <div>
      <p class="h4">書籍タイトル:</p>
      <p id="BookTitle"></p>
    </div>
    <div>
      <p class="h4">著者:</p>
      <p id="BookAuthor"></p>
    </div>
    <div>
      <p class="h4">ISBN10:</p>
      <p id="isbn10"></p>
    </div>
    <div>
      <p class="h4">ISBN13:</p>
      <p id="isbn13"></p>
    </div>
    <div>
      <p class="h4">出版日:</p>
      <p id="PublishedDate"></p>
    </div>
    <div>
      <p class="h4">書籍サムネイル:</p>
      <p id="book_list"></p>
    </div>
    <div>
      <p class="h4">書籍概要:</p>
      <p id="BookDescription"></p>
    </div>
    <div>
      <p class="h4">メモ:</p>
      <textarea class="form-control" rows="5" id="BookMemo"></textarea>
    </div> %>
    <div id="book_list"></div>
</div>


</body>
</html>
